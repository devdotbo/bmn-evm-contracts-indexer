# V2.2.0 Schema Updates - PostInteraction Support

## Overview
Extended the Ponder schema to support v2.2.0 factory functionality with PostInteraction-based atomic escrow creation and 1inch order tracking.

## New Tables Added

### 1. PostInteractionOrder (`post_interaction_order`)
Tracks 1inch orders that use PostInteraction for atomic escrow creation.

**Fields:**
- `id`: string (orderHash) - Primary key
- `orderHash`: hex - Unique order identifier
- `maker`: hex - Order maker address
- `taker`: hex - Order taker address  
- `makerAsset`: hex - Asset being sold
- `takerAsset`: hex - Asset being bought
- `makingAmount`: bigint - Amount of maker asset
- `takingAmount`: bigint - Amount of taker asset
- `srcEscrow`: hex (nullable) - Source escrow address (set when PostInteraction executes)
- `dstEscrow`: hex (nullable) - Destination escrow address (set when PostInteraction executes)
- `status`: text - Order status ("pending", "filled", "cancelled")
- `filledAt`: bigint (nullable) - Timestamp when order was filled
- `chainId`: integer - Chain identifier
- `blockNumber`: bigint - Block number of creation
- `timestamp`: bigint - Creation timestamp
- `transactionHash`: hex - Transaction hash

**Indexes:**
- `orderHashIdx`: Index on orderHash for fast lookups

### 2. PostInteractionResolverWhitelist (`post_interaction_resolver_whitelist`)
Tracks whitelisted resolvers for PostInteraction execution.

**Fields:**
- `id`: string (resolver-chainId) - Primary key
- `resolver`: hex - Resolver address
- `chainId`: integer - Chain identifier
- `isWhitelisted`: boolean - Current whitelist status
- `whitelistedAt`: bigint - Timestamp when whitelisted
- `removedAt`: bigint (nullable) - Timestamp when removed from whitelist
- `blockNumber`: bigint - Block number of last status change
- `transactionHash`: hex - Transaction hash of last status change

**Indexes:**
- `resolverChainIdx`: Composite index on (resolver, chainId)

### 3. MakerWhitelist (`maker_whitelist`) 
Tracks whitelisted makers allowed to create PostInteraction orders.

**Fields:**
- `id`: string (maker-chainId) - Primary key
- `maker`: hex - Maker address
- `chainId`: integer - Chain identifier
- `isWhitelisted`: boolean - Current whitelist status
- `whitelistedAt`: bigint - Timestamp when whitelisted
- `removedAt`: bigint (nullable) - Timestamp when removed from whitelist
- `blockNumber`: bigint - Block number of last status change
- `transactionHash`: hex - Transaction hash of last status change

**Indexes:**
- `makerChainIdx`: Composite index on (maker, chainId)

### 4. PostInteractionEscrow (`post_interaction_escrow`)
Links PostInteraction orders to created escrows.

**Fields:**
- `id`: string (orderHash-escrowType) - Primary key
- `orderHash`: hex - Related order hash
- `escrowAddress`: hex - Created escrow address
- `escrowType`: text - Type of escrow ("src" or "dst")
- `chainId`: integer - Chain identifier
- `createdAt`: bigint - Creation timestamp
- `blockNumber`: bigint - Block number of creation
- `transactionHash`: hex - Transaction hash

**Indexes:**
- `orderHashIdx`: Index on orderHash for joining with orders

## Updated Tables

### AtomicSwap (`atomic_swap`)
Added field to track PostInteraction-based swaps:
- `postInteraction`: boolean (default: false) - Indicates if swap was created via PostInteraction

## Usage Notes

1. **Order Lifecycle**:
   - Orders start with status "pending" when created
   - When PostInteraction executes, srcEscrow and dstEscrow fields are populated
   - Status changes to "filled" when order completes
   - Status changes to "cancelled" if order is cancelled

2. **Whitelist Management**:
   - Resolvers and makers must be whitelisted to use PostInteraction
   - Track whitelist changes over time with timestamps
   - `isWhitelisted` field provides current status
   - `removedAt` field tracks when access was revoked

3. **Cross-Chain Correlation**:
   - Use orderHash to link PostInteractionOrder with PostInteractionEscrow entries
   - PostInteractionEscrow tracks both source and destination escrows
   - AtomicSwap.postInteraction flag identifies PostInteraction-based swaps

## Integration Points

The new schema integrates with existing tables:
- Links to `srcEscrow` and `dstEscrow` tables via escrow addresses
- Updates `atomicSwap` entries with PostInteraction flag
- Compatible with existing chain statistics and metrics

## Next Steps

1. Implement event handlers for:
   - OrderFilled events from 1inch protocol
   - PostInteractionExecuted events from factory
   - ResolverWhitelisted/ResolverRemoved events
   - MakerWhitelisted/MakerRemoved events

2. Update indexing logic to:
   - Track order lifecycle from creation to completion
   - Link PostInteraction orders to created escrows
   - Update atomicSwap entries with PostInteraction flag

3. Add GraphQL queries for:
   - Querying orders by maker/taker
   - Filtering orders by status
   - Finding escrows created via PostInteraction
   - Checking whitelist status